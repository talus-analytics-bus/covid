{"ast":null,"code":"import _slicedToArray from \"/Users/trae/git_repositories/measles/dash/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nvar _jsxFileName = \"/Users/trae/git_repositories/measles/dash/src/components/map/Map.js\";\nimport React from 'react';\nimport ReactMapGL, { NavigationControl, Popup } from 'react-map-gl'; //import axios from 'axios'\n//import classNames from 'classnames'\n\nimport 'mapbox-gl/dist/mapbox-gl.css';\nimport './map.scss'; //import styles from './map.module.scss'\n\nimport initMap from './mapUtils';\nimport Legend from './legend/Legend';\nimport ResetZoom from './resetZoom/ResetZoom'; //import Filter from './filter/Filter'\n\nimport GeomPopup from './geomPopup/GeomPopup.js';\nconst TOKEN = process.env.REACT_APP_MAPBOX_ACCESS_TOKEN;\n\nconst Map = ({\n  fillObservations,\n  bubbleObservations,\n  mappedFacilityTypes,\n  setMappedFacilityTypes\n}) => {\n  const defaultViewport = {\n    width: '100%',\n    height: '100%',\n    longitude: 0,\n    latitude: 20,\n    zoom: 2\n  };\n\n  const _React$useState = React.useState(defaultViewport),\n        _React$useState2 = _slicedToArray(_React$useState, 2),\n        viewport = _React$useState2[0],\n        setViewport = _React$useState2[1]; //const [selectedGeom, setSelectedGeom] = React.useState('')\n\n\n  const _React$useState3 = React.useState(-1),\n        _React$useState4 = _slicedToArray(_React$useState3, 2),\n        selectedGeomID = _React$useState4[0],\n        setSelectedGeomID = _React$useState4[1];\n\n  const _React$useState5 = React.useState([0, 0]),\n        _React$useState6 = _slicedToArray(_React$useState5, 2),\n        cursorLngLat = _React$useState6[0],\n        setCursorLngLat = _React$useState6[1];\n\n  const _React$useState7 = React.useState(false),\n        _React$useState8 = _slicedToArray(_React$useState7, 2),\n        showGeomPopup = _React$useState8[0],\n        setShowGeomPopup = _React$useState8[1];\n\n  const _React$useState9 = React.useState({}),\n        _React$useState10 = _slicedToArray(_React$useState9, 2),\n        popupData = _React$useState10[0],\n        setPopupData = _React$useState10[1]; // Whether the reset button is shown or not. Controlled by the viewport\n  // setting being other than the default.\n\n\n  const _React$useState11 = React.useState(false),\n        _React$useState12 = _slicedToArray(_React$useState11, 2),\n        showReset = _React$useState12[0],\n        setShowReset = _React$useState12[1];\n\n  let mapRef = React.createRef();\n  React.useEffect(() => {\n    const map = mapRef.getMap();\n    initMap(map, fillObservations, bubbleObservations);\n  }, []);\n  /**\n   * Reset the viewport to the default values. This is fired when the \"Reset\"\n   * button is clicked.\n   * @method resetViewport\n   */\n\n  const resetViewport = () => {\n    // Hide the reset button after click.\n    setShowReset(false); // Hide tooltip\n\n    setShowGeomPopup(false); // Change viewport back to default.\n\n    setViewport(defaultViewport);\n  };\n  /**\n   * Fired when mouse moves on map, mainly to handle cursor styling.\n   * @method handleMouseMove\n   * @param  {obj}        e Mousemove event.\n   */\n\n\n  const handleMouseMove = e => {\n    // Get map reference object.\n    const map = mapRef.getMap(); // Get list of features under the mouse cursor.\n\n    const features = map.queryRenderedFeatures(e.point); // Use pointer cursor for any country, grab cursor otherwise.\n\n    const onCountry = features.find(f => f['id'] > 0) !== undefined;\n    map.getContainer().parentElement.parentElement.style.cursor = onCountry ? 'pointer' : 'grab';\n  };\n  /**\n  * Fired when window is resized\n  * @method handleResize\n  */\n\n\n  const handleResize = () => {\n    mapRef.getMap().resize();\n  };\n  /**\n   * Fired when map is clicked.\n   * @method handleClick\n   * @param  {obj}    e Click event.\n   */\n\n\n  const handleClick = e => {\n    /**\n     * Returns true if user clicked any part of the legend or the filter menus\n     * (rather than directly on the map), and false otherwise.\n     * @method clickedMenus\n     * @param  {obj}      e Click event.\n     * @return {bool}        Boolean result (see description).\n     */\n    const clickedMenus = e => {\n      try {\n        if (e.target.className.includes('legend') || e.target.className.includes('filter') || e.target.offsetParent.className.includes('legend') || e.target.offsetParent.className.includes('filter')) {\n          return true;\n        }\n      } catch {\n        console.log('[Error] Unexpected click event: ');\n        console.log(e);\n        return false;\n      }\n\n      return false;\n    }; // If the user clicked on the legend and not on the actual map, do nothing.\n    // Otherwise, do the correct map interaction.\n\n\n    if (clickedMenus(e)) return; // Otherwise, highlight state and show its tooltip.\n\n    const map = mapRef.getMap(); // If there is a highlighted country, turn it off\n\n    if (selectedGeomID > 0) {\n      map.setFeatureState({\n        source: 'geoms',\n        sourceLayer: 'countries_id-3n17an',\n        id: selectedGeomID\n      }, {\n        clicked: false\n      });\n      setShowGeomPopup(false); //setSelectedGeom('')\n\n      setSelectedGeomID(-1);\n    }\n\n    const clickedOnGeom = e.features.find(f => f.layer.id === 'geom-fills');\n    if (typeof clickedOnGeom === 'undefined') return;\n    console.log(clickedOnGeom);\n    const id = clickedOnGeom.id;\n    map.setFeatureState({\n      source: 'geoms',\n      sourceLayer: 'countries_id-3n17an',\n      id: id\n    }, {\n      clicked: true\n    }); //setSelectedGeom(clickedOnGeom.properties.ADMIN)\n\n    const bubbleData = bubbleObservations.find(f => f.place_id === id);\n    const fillData = fillObservations.find(f => f.place_id === id);\n    setPopupData({\n      'fill': fillData,\n      'bubble': bubbleData\n    });\n    setSelectedGeomID(id);\n    setCursorLngLat(e.lngLat);\n    setShowGeomPopup(true);\n    /**\n     * Fly user to specified longlat map location, and (if provided) to the\n     * final zoom value -- otherwise the zoom value is 150% of the current\n     * zoom value or 8, whichever is smaller.\n     * @method flyToLongLat\n     * @param  {array}     longlat   Longlat coord in decimal deg\n     * @param  {float}     finalZoom Zoom value to end on, or null\n     * @param  {object}     viewport  Viewport state variable\n     * @param  {object}     mapRef    MapBox map reference object\n     * @param  {function}     callback    Optional callback function when done\n     */\n\n    const flyToLongLat = (longlat, finalZoom, viewport, mapRef, callback = () => {}) => {\n      // Get current zoom level.\n      const curZoom = viewport.zoom; // Set zoom level to fly to (0 to 24 inclusive). Either zoom in by 20% or\n      // the minimum zoom level required to see facilities, whichever is\n      // smaller. Use final zoom if it specified.\n\n      const flyZoom = finalZoom !== null ? finalZoom : Math.min(4, curZoom * 1.50); // Start off flying\n\n      let flying = true;\n      /**\n       * When flying stops, update the viewport position to match the place\n       * that was flown to.\n       * @method onFlyEnd\n       */\n\n      function onFlyEnd() {\n        // Get map object reference.\n        const map = mapRef.getMap(); // Delete the event listener for the end of movement (we only want it to\n        // be called when the current flight is over).\n\n        map.off('moveend', onFlyEnd); // If flying,\n\n        if (flying) {\n          // Stop flying,\n          flying = false; // Set viewport state to the flight destination and zoom level\n\n          const newViewport = {\n            width: '100%',\n            height: '100%',\n            longitude: longlat[0],\n            latitude: longlat[1],\n            zoom: flyZoom\n          };\n          setViewport(newViewport);\n          if (callback) callback();\n        }\n      }\n\n      ; // Get map object reference.\n\n      const map = mapRef.getMap(); // Assign event listener so viewport is updated when flight is over.\n\n      map.on('moveend', onFlyEnd); // Fly to the position occupied by the clicked cluster on the map.\n\n      map.flyTo({\n        center: longlat,\n        zoom: flyZoom,\n        bearing: 0,\n        speed: 2,\n        curve: 1,\n        easing: function (t) {\n          return t;\n        }\n      });\n      setShowReset(true);\n    };\n  };\n\n  const onPopupClose = () => {\n    const map = mapRef.getMap();\n    const id = selectedGeomID;\n    map.setFeatureState({\n      source: 'geoms',\n      sourceLayer: 'countries_id-3n17an',\n      id: id\n    }, {\n      clicked: false\n    });\n    setShowGeomPopup(false); //setSelectedGeom('')\n\n    setSelectedGeomID(-1);\n  };\n\n  return React.createElement(ReactMapGL, Object.assign({\n    ref: map => mapRef = map,\n    mapboxApiAccessToken: TOKEN //mapStyle='mapbox://styles/mapbox/streets-v10'\n    ,\n    mapStyle: \"mapbox://styles/traethethird/ck0ia6pvc2cpc1cpe5nx5b7p5\"\n  }, viewport, {\n    maxZoom: 4,\n    minZoom: 2,\n    onViewportChange: v => {\n      // Update viewport.\n      setViewport(v); // If viewport deviates from the default zoom or longlat, show the\n      // \"Reset\" button in the bottom left. Otherwise, hide it.\n\n      if (v.zoom !== defaultViewport.zoom || v.longitude !== defaultViewport.longitude || v.latitude !== defaultViewport.latitude) setShowReset(true);else setShowReset(false);\n    },\n    onClick: handleClick,\n    onMouseMove: handleMouseMove,\n    onResize: handleResize,\n    doubleClickZoom: false //remove 300ms delay on clicking\n    ,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 244\n    },\n    __self: this\n  }), React.createElement(\"div\", {\n    style: {\n      position: 'absolute',\n      bottom: '30px',\n      left: 0,\n      padding: '10px'\n    },\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 270\n    },\n    __self: this\n  }, React.createElement(NavigationControl, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 278\n    },\n    __self: this\n  })), React.createElement(Legend, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 280\n    },\n    __self: this\n  }), showReset && React.createElement(ResetZoom, {\n    handleClick: resetViewport,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 281\n    },\n    __self: this\n  }), showGeomPopup && React.createElement(Popup, {\n    color: \"#4286f4\",\n    style: {\n      margin: 0,\n      padding: 0,\n      backgroundColor: '#4286f4'\n    },\n    longitude: cursorLngLat[0],\n    latitude: cursorLngLat[1],\n    closeButton: true,\n    closeOnClick: true,\n    onClose: onPopupClose,\n    anchor: \"top\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 283\n    },\n    __self: this\n  }, React.createElement(GeomPopup, {\n    popupData: popupData,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 293\n    },\n    __self: this\n  })));\n};\n\nexport default Map;","map":{"version":3,"sources":["/Users/trae/git_repositories/measles/dash/src/components/map/Map.js"],"names":["React","ReactMapGL","NavigationControl","Popup","initMap","Legend","ResetZoom","GeomPopup","TOKEN","process","env","REACT_APP_MAPBOX_ACCESS_TOKEN","Map","fillObservations","bubbleObservations","mappedFacilityTypes","setMappedFacilityTypes","defaultViewport","width","height","longitude","latitude","zoom","useState","viewport","setViewport","selectedGeomID","setSelectedGeomID","cursorLngLat","setCursorLngLat","showGeomPopup","setShowGeomPopup","popupData","setPopupData","showReset","setShowReset","mapRef","createRef","useEffect","map","getMap","resetViewport","handleMouseMove","e","features","queryRenderedFeatures","point","onCountry","find","f","undefined","getContainer","parentElement","style","cursor","handleResize","resize","handleClick","clickedMenus","target","className","includes","offsetParent","console","log","setFeatureState","source","sourceLayer","id","clicked","clickedOnGeom","layer","bubbleData","place_id","fillData","lngLat","flyToLongLat","longlat","finalZoom","callback","curZoom","flyZoom","Math","min","flying","onFlyEnd","off","newViewport","on","flyTo","center","bearing","speed","curve","easing","t","onPopupClose","v","position","bottom","left","padding","margin","backgroundColor"],"mappings":"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","sourcesContent":["import React from 'react'\nimport ReactMapGL, { NavigationControl, Popup } from 'react-map-gl'\n//import axios from 'axios'\n\n//import classNames from 'classnames'\n\nimport 'mapbox-gl/dist/mapbox-gl.css'\nimport './map.scss'\n//import styles from './map.module.scss'\n\nimport initMap from './mapUtils'\n\nimport Legend from './legend/Legend'\nimport ResetZoom from './resetZoom/ResetZoom'\n//import Filter from './filter/Filter'\nimport GeomPopup from './geomPopup/GeomPopup.js'\n\nconst TOKEN = process.env.REACT_APP_MAPBOX_ACCESS_TOKEN\n\nconst Map = ({ fillObservations, bubbleObservations, mappedFacilityTypes, setMappedFacilityTypes }) => {\n\n  const defaultViewport = {\n    width: '100%',\n    height: '100%',\n    longitude: 0,\n    latitude: 20,\n    zoom: 2\n  };\n  const [viewport, setViewport] = React.useState(defaultViewport);\n  //const [selectedGeom, setSelectedGeom] = React.useState('')\n  const [selectedGeomID, setSelectedGeomID] = React.useState(-1)\n  const [cursorLngLat, setCursorLngLat] = React.useState([0, 0])\n  const [showGeomPopup, setShowGeomPopup] = React.useState(false)\n  const [popupData, setPopupData] = React.useState({})\n\n  // Whether the reset button is shown or not. Controlled by the viewport\n  // setting being other than the default.\n  const [showReset, setShowReset] = React.useState(false);\n\n  let mapRef = React.createRef()\n  React.useEffect(() => {\n    const map = mapRef.getMap()\n    initMap(map, fillObservations, bubbleObservations)\n  }, [])\n\n\n  /**\n   * Reset the viewport to the default values. This is fired when the \"Reset\"\n   * button is clicked.\n   * @method resetViewport\n   */\n  const resetViewport = () => {\n\n    // Hide the reset button after click.\n    setShowReset(false);\n\n    // Hide tooltip\n    setShowGeomPopup(false);\n\n    // Change viewport back to default.\n    setViewport(defaultViewport);\n  };\n\n  /**\n   * Fired when mouse moves on map, mainly to handle cursor styling.\n   * @method handleMouseMove\n   * @param  {obj}        e Mousemove event.\n   */\n  const handleMouseMove = e => {\n    // Get map reference object.\n    const map = mapRef.getMap();\n\n    // Get list of features under the mouse cursor.\n    const features = map.queryRenderedFeatures(e.point);\n\n    // Use pointer cursor for any country, grab cursor otherwise.\n    const onCountry = features.find(f => f['id'] > 0) !== undefined;\n\n    map.getContainer().parentElement.parentElement.style.cursor =\n      onCountry ? 'pointer' : 'grab';\n  };\n\n  /**\n  * Fired when window is resized\n  * @method handleResize\n  */\n  const handleResize = () => {\n    mapRef.getMap().resize();\n  }\n\n  /**\n   * Fired when map is clicked.\n   * @method handleClick\n   * @param  {obj}    e Click event.\n   */\n  const handleClick = e => {\n    /**\n     * Returns true if user clicked any part of the legend or the filter menus\n     * (rather than directly on the map), and false otherwise.\n     * @method clickedMenus\n     * @param  {obj}      e Click event.\n     * @return {bool}        Boolean result (see description).\n     */\n    const clickedMenus = (e) => {\n      try {\n        if (\n          e.target.className.includes('legend')\n          || e.target.className.includes('filter')\n          || e.target.offsetParent.className.includes('legend')\n          || e.target.offsetParent.className.includes('filter')) {\n            return true;\n          }\n        } catch {\n          console.log('[Error] Unexpected click event: ')\n          console.log(e);\n          return false;\n        }\n        return false;\n    };\n\n    // If the user clicked on the legend and not on the actual map, do nothing.\n    // Otherwise, do the correct map interaction.\n    if (clickedMenus(e)) return;\n\n    // Otherwise, highlight state and show its tooltip.\n    const map = mapRef.getMap()\n\n    // If there is a highlighted country, turn it off\n    if (selectedGeomID > 0) {\n      map.setFeatureState({source: 'geoms', sourceLayer: 'countries_id-3n17an', id: selectedGeomID }, {clicked: false});\n      setShowGeomPopup(false)\n      //setSelectedGeom('')\n      setSelectedGeomID(-1)\n    }\n\n    const clickedOnGeom = e.features.find(f => f.layer.id === 'geom-fills')\n\n    if (typeof clickedOnGeom === 'undefined') return;\n\n    console.log(clickedOnGeom)\n\n    const id = clickedOnGeom.id\n    map.setFeatureState({source: 'geoms', sourceLayer: 'countries_id-3n17an', id: id }, {clicked: true});\n\n    //setSelectedGeom(clickedOnGeom.properties.ADMIN)\n\n    const bubbleData = bubbleObservations.find(f => f.place_id === id)\n    const fillData = fillObservations.find(f => f.place_id === id)\n\n    setPopupData({'fill': fillData, 'bubble': bubbleData})\n\n    setSelectedGeomID(id)\n    setCursorLngLat(e.lngLat)\n    setShowGeomPopup(true)\n\n    /**\n     * Fly user to specified longlat map location, and (if provided) to the\n     * final zoom value -- otherwise the zoom value is 150% of the current\n     * zoom value or 8, whichever is smaller.\n     * @method flyToLongLat\n     * @param  {array}     longlat   Longlat coord in decimal deg\n     * @param  {float}     finalZoom Zoom value to end on, or null\n     * @param  {object}     viewport  Viewport state variable\n     * @param  {object}     mapRef    MapBox map reference object\n     * @param  {function}     callback    Optional callback function when done\n     */\n    const flyToLongLat = (longlat, finalZoom, viewport, mapRef, callback = () => {}) => {\n\n      // Get current zoom level.\n      const curZoom = viewport.zoom;\n\n      // Set zoom level to fly to (0 to 24 inclusive). Either zoom in by 20% or\n      // the minimum zoom level required to see facilities, whichever is\n      // smaller. Use final zoom if it specified.\n      const flyZoom = finalZoom !== null ?\n        finalZoom : Math.min(4, curZoom*1.50);\n\n      // Start off flying\n      let flying = true;\n\n      /**\n       * When flying stops, update the viewport position to match the place\n       * that was flown to.\n       * @method onFlyEnd\n       */\n      function onFlyEnd () {\n\n        // Get map object reference.\n        const map = mapRef.getMap();\n\n        // Delete the event listener for the end of movement (we only want it to\n        // be called when the current flight is over).\n        map.off('moveend', onFlyEnd);\n\n        // If flying,\n        if (flying) {\n\n          // Stop flying,\n          flying = false;\n\n          // Set viewport state to the flight destination and zoom level\n          const newViewport = {\n            width: '100%',\n            height: '100%',\n            longitude: longlat[0],\n            latitude: longlat[1],\n            zoom: flyZoom,\n          };\n          setViewport(newViewport);\n          if (callback) callback();\n        }\n      };\n\n      // Get map object reference.\n      const map = mapRef.getMap();\n\n      // Assign event listener so viewport is updated when flight is over.\n      map.on('moveend', onFlyEnd);\n\n      // Fly to the position occupied by the clicked cluster on the map.\n      map.flyTo({\n        center: longlat,\n        zoom: flyZoom,\n        bearing: 0,\n        speed: 2,\n        curve: 1,\n        easing: function (t) { return t; }\n      });\n\n      setShowReset(true);\n    };\n  }\n\n  const onPopupClose = () => {\n    const map = mapRef.getMap()\n    const id = selectedGeomID\n    map.setFeatureState({source: 'geoms', sourceLayer: 'countries_id-3n17an', id: id }, {clicked: false});\n    setShowGeomPopup(false)\n    //setSelectedGeom('')\n    setSelectedGeomID(-1)\n  }\n\n  return (\n    <ReactMapGL\n      ref={map => (mapRef = map)}\n      mapboxApiAccessToken={TOKEN}\n      //mapStyle='mapbox://styles/mapbox/streets-v10'\n      mapStyle='mapbox://styles/traethethird/ck0ia6pvc2cpc1cpe5nx5b7p5'\n      {...viewport}\n      maxZoom = {4}\n      minZoom = {2}\n      onViewportChange={v => {\n        // Update viewport.\n        setViewport(v);\n\n        // If viewport deviates from the default zoom or longlat, show the\n        // \"Reset\" button in the bottom left. Otherwise, hide it.\n        if (\n            v.zoom !== defaultViewport.zoom\n            || v.longitude !== defaultViewport.longitude\n            || v.latitude !== defaultViewport.latitude\n          ) setShowReset(true);\n        else setShowReset(false);\n      }}\n      onClick={handleClick}\n      onMouseMove={handleMouseMove}\n      onResize={handleResize}\n      doubleClickZoom={false} //remove 300ms delay on clicking\n    >\n      <div\n        style={{\n          position: 'absolute',\n          bottom: '30px',\n          left: 0,\n          padding: '10px'\n        }}\n      >\n      <NavigationControl />\n      </div>\n      <Legend />\n      {showReset && (<ResetZoom handleClick={resetViewport}/>)}\n      {showGeomPopup && (\n        <Popup\n          color='#4286f4'\n          style={{ margin: 0, padding: 0, backgroundColor: '#4286f4' }}\n          longitude={cursorLngLat[0]}\n          latitude={cursorLngLat[1]}\n          closeButton={true}\n          closeOnClick={true}\n          onClose={onPopupClose}\n          anchor='top'\n        >\n          <GeomPopup\n            popupData={popupData}\n          />\n        </Popup>\n      )}\n    </ReactMapGL>\n  )\n}\n\nexport default Map\n"]},"metadata":{},"sourceType":"module"}